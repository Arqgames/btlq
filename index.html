<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />

    <!-- ç”»é¢è¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- åŸºæœ¬SEO -->
    <title>Bible Timeline Quiz</title>
    <meta name="description"
        content="Bible Timeline Quiz is a free browser game where you arrange Bible events in chronological order. Supports Japanese and English." />

    <!-- æ¤œç´¢çµæœã®è¡¨ç¤ºå¼·åŒ–ï¼ˆOpen Graph / Twitterï¼‰ -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Bible Timeline Quiz" />
    <meta property="og:description"
        content="A free browser game where you arrange Bible events in chronological order. Supports Japanese and English." />
    <!-- TODO: å…¬é–‹URLãŒç¢ºå®šã—ãŸã‚‰ã“ã“ã‚’æ›¸ãæ›ãˆï¼ˆGitHub Pagesã®URLï¼‰ -->
    <!-- ä¾‹: https://btlq.github.io/ -->
    <meta property="og:url" content="https://YOUR_GITHUB_PAGES_URL/" />

    <!-- TODO: ã‚µãƒ ãƒç”»åƒã‚’ç½®ãå ´åˆï¼ˆ/og.png ãªã©ï¼‰ -->
    <!-- <meta property="og:image" content="https://YOUR_GITHUB_PAGES_URL/og.png" /> -->

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Bible Timeline Quiz" />
    <meta name="twitter:description"
        content="A free browser game where you arrange Bible events in chronological order. Supports Japanese and English." />

    <!-- è¡¨ç¤ºã®é›°å›²æ°—ï¼ˆä»»æ„ï¼‰ -->
    <meta name="theme-color" content="#f4e4bc" />

    <!-- ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»»æ„ï¼šå¾Œã§è¿½åŠ ã—ã¦OKï¼‰ -->
    <!-- <link rel="icon" href="/favicon.ico" /> -->
    <!-- <link rel="apple-touch-icon" href="/apple-touch-icon.png" /> -->

    <!-- ãƒ•ã‚©ãƒ³ãƒˆ / ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã‚ãªãŸã®ç¾çŠ¶ã‚’ç¶­æŒï¼‰ -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --main-bg: #f4e4bc;
            --card-bg: #fff9e6;
            --accent: #fbc531;
            --text: #5d3a1a;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
            background-color: var(--main-bg);
            margin: 0;
            padding: 20px 0;
            color: var(--text);
            touch-action: manipulation;
        }

        .container {
            background: var(--card-bg);
            padding: 30px 20px;
            border-radius: 40px;
            box-shadow: 0 10px 0 #d4af37;
            width: 92%;
            max-width: 450px;
            text-align: center;
            border: 8px solid var(--accent);
            position: relative;
            margin: 40px auto;
            box-sizing: border-box;
        }

        .top-btn {
            position: absolute;
            top: -65px;
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            border: 3px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 0 #d4af37;
            z-index: 100;
            font-weight: bold;
            color: var(--text);
            font-size: 0.85em;
        }

        .home-btn {
            left: 10px;
            border-color: #8b5e3c;
            box-shadow: 0 4px 0 #8b5e3c;
            color: #8b5e3c;
        }

        .lang-switch {
            right: 10px;
        }

        .header-icon-box {
            background: #fff;
            width: 70px;
            height: 70px;
            margin: -65px auto 10px;
            border-radius: 50%;
            border: 5px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 0 #d4af37;
        }

        .header-icon {
            font-size: 35px !important;
            color: #f39c12;
        }

        .quick-btn-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .q-btn {
            background: #8b5e3c;
            color: white;
            border: none;
            padding: 12px 5px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #5d3a1a;
        }

        .q-btn.full {
            grid-column: span 2;
            background: #5d3a1a;
        }

        .q-btn.active {
            background: #d35400;
            box-shadow: 0 4px 0 #a04000;
            outline: 2px solid #fff;
        }

        .picker-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            background: rgba(255, 255, 255, 0.6);
            padding: 12px;
            border-radius: 15px;
            border: 2px solid #ecd4a1;
            margin: 10px 0;
        }

        .picker-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            font-weight: bold;
            background: #fff;
            font-size: 0.9em;
        }

        .btn {
            background: linear-gradient(to bottom, #ffc048, #ff9f1a);
            color: #fff;
            border: none;
            padding: 18px;
            border-radius: 35px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 6px 0 #cc8e35;
            width: 100%;
            margin: 10px 0;
        }

        .btn-sub {
            background: #8b5e3c;
            box-shadow: 0 6px 0 #5d3a1a;
        }

        #error-msg {
            color: #d63031;
            font-weight: bold;
            font-size: 0.85em;
            height: 1.2em;
            margin-bottom: 5px;
            transition: 0.3s;
        }

        .event-card {
            background: #fff;
            border-radius: 15px;
            margin: 12px 0;
            padding: 18px 15px;
            cursor: grab;
            font-weight: bold;
            border: 2px solid var(--accent);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.05);
            user-select: none;
        }

        .event-card.dragging {
            transform: scale(1.03);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: #fbc531;
            background: #fff;
        }


        .hidden {
            display: none !important;
        }

        #hint-area {
            background: #fff5d7;
            border: 3px dashed #f39c12;
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
            font-weight: bold;
            text-align: left;
            font-size: 0.85em;
            white-space: pre-line;
        }

        .hint-item {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ecd4a1;
        }

        .hint-desc {
            font-weight: normal;
            font-size: 0.9em;
            color: #8b5e3c;
            margin-left: 1.2em;
            display: block;
        }

        /* ä¸¦ã³æ›¿ãˆæ™‚ã®æŒ¿å…¥ä½ç½®ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰ */
        .sortable-placeholder {
            height: 64px;
            /* ã‚«ãƒ¼ãƒ‰ã®ã ã„ãŸã„ã®é«˜ã•ã€‚å¾Œã§èª¿æ•´OK */
            margin: 12px 0;
            border-radius: 15px;
            border: 3px dashed var(--accent);
            background: rgba(251, 197, 49, 0.15);
        }
    </style>

</head>

<body>

    <div class="container">
        <div class="top-btn home-btn" onclick="location.reload()"><span class="material-icons">home</span></div>
        <div class="top-btn lang-switch" onclick="toggleLang()" id="lang-btn">JA</div>

        <div id="screen-setup">
            <div class="header-icon-box"><span class="material-icons header-icon">menu_book</span></div>
            <h1 data-ja="è–æ›¸å¹´è¡¨ã‚¯ã‚¤ã‚º" data-en="Bible Timeline Quiz">è–æ›¸å¹´è¡¨ã‚¯ã‚¤ã‚º</h1>

            <div class="quick-btn-container">
                <button class="q-btn full" onclick="quickSet(-4026, 98, this)" data-ja="å…¨æœŸé–“"
                    data-en="All Periods">å…¨æœŸé–“</button>
                <button class="q-btn" onclick="quickSet(-4026, -2370, this)" data-ja="äººé¡åˆæœŸ"
                    data-en="Early Human">äººé¡åˆæœŸ</button>
                <button class="q-btn" onclick="quickSet(-2018, -1513, this)" data-ja="æ—é•·æ™‚ä»£"
                    data-en="Patriarchs">æ—é•·æ™‚ä»£</button>
                <button class="q-btn" onclick="quickSet(-1513, -1070, this)" data-ja="ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«å¾æœ"
                    data-en="Conquest">ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«å¾æœ</button>
                <button class="q-btn" onclick="quickSet(-1070, -607, this)" data-ja="ç‹å›½ã®ç››è¡°"
                    data-en="Kings">ç‹å›½ã®ç››è¡°</button>
                <button class="q-btn" onclick="quickSet(-607, -2, this)" data-ja="æ•å›šãƒ»å†å»º"
                    data-en="Exile & Return">æ•å›šãƒ»å†å»º</button>
                <button class="q-btn" onclick="quickSet(-2, 98, this)" data-ja="ã‚­ãƒªã‚¹ãƒˆãƒ»ä½¿å¾’"
                    data-en="Jesus & Apostles">ã‚­ãƒªã‚¹ãƒˆãƒ»ä½¿å¾’</button>
            </div>

            <div class="picker-group">
                <div class="picker-column"><span style="font-size:0.75em; font-weight:bold;" data-ja="é–‹å§‹"
                        data-en="Start">é–‹å§‹</span><select id="select-start"></select></div>
                <div class="picker-column"><span style="font-size:0.75em; font-weight:bold;" data-ja="çµ‚äº†"
                        data-en="End">çµ‚äº†</span><select id="select-end"></select></div>
            </div>

            <select id="count-select" style="width:100%; margin-top:15px;">
                <option value="3" data-ja="3å• ã€åˆç´šã€‘" data-en="3 Events [Easy]">3å• ã€åˆç´šã€‘</option>
                <option value="5" selected data-ja="5å• ã€ãƒãƒ¼ãƒãƒ«ã€‘" data-en="5 Events [Normal]">5å• ã€ãƒãƒ¼ãƒãƒ«ã€‘</option>
                <option value="8" data-ja="8å• ã€ãƒãƒ¼ãƒ‰ã€‘" data-en="8 Events [Hard]">8å• ã€ãƒãƒ¼ãƒ‰ã€‘</option>
                <option value="12" data-ja="12å• ã€ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã€‘" data-en="12 Events [Legend]">12å• ã€ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã€‘</option>
                <option value="30" data-ja="30å• ã€ã‚´ãƒƒãƒ‰ã€‘" data-en="30 Events [God Mode]">30å• ã€ã‚´ãƒƒãƒ‰ã€‘</option>
            </select>
            <select id="time-attack-select" style="width:100%; margin-top:10px;">
                <option value="off" data-ja="ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šOFF" data-en="Time Attack: OFF">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šOFF</option>
                <option value="on" data-ja="ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šON" data-en="Time Attack: ON">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šON</option>
            </select>
            <div id="error-msg"></div>
            <button class="btn" onclick="startGame()" data-ja="å†’é™ºã‚’é–‹å§‹" data-en="Start Adventure">å†’é™ºã‚’é–‹å§‹</button>
        </div>

        <div id="screen-game" class="hidden">
            <div id="timer-display" style="font-size: 1.5em; font-weight: bold; color: #d63031; margin-bottom: 10px;">
                â± <span id="time-left">00</span>s
            </div>
            <div id="event-list"></div>
            <div id="hint-area" class="hidden"></div>
            <button class="btn" onclick="checkOrder()" data-ja="ç­”ãˆåˆã‚ã›" data-en="Check Answer">ç­”ãˆåˆã‚ã›</button>
        </div>

        <div id="screen-result" class="hidden">
            <div class="header-icon-box"><span class="material-icons header-icon" id="result-icon">star</span></div>
            <h2 id="result-title"></h2>
            <div id="fail-options" class="hidden">
                <button class="btn" onclick="showHint()" data-ja="ãƒ’ãƒ³ãƒˆ" data-en="Hint">ãƒ’ãƒ³ãƒˆ</button>
                <button class="btn btn-sub" onclick="retryThisTask()" data-ja="å†æŒ‘æˆ¦" data-en="Retry">å†æŒ‘æˆ¦</button>
            </div>
            <div id="success-options" class="hidden"><button class="btn" onclick="location.reload()" data-ja="æ¬¡ã¸"
                    data-en="Next">æ¬¡ã¸</button></div>
        </div>
    </div>

    <script>
        let currentLang = 'ja';
        let currentTask = [];
        let timerInterval;
        let timeLeft;
        /* çµæœç”»é¢ã®å†æç”»ç”¨ï¼šç›´å‰ã®å‹æ•—ã‚’è¦šãˆã‚‹ */
        let lastIsWin = null;
        /* ãƒ’ãƒ³ãƒˆå†æç”»ç”¨ï¼šç›´å‰ã«è¡¨ç¤ºã—ãŸãƒ’ãƒ³ãƒˆã®IDã‚’è¦šãˆã‚‹ */
        let lastHintIds = null;
        let lastHintWasEmpty = null;

        const refMap = {
            "Gen": "å‰µ", "Exo": "å‡º", "Lev": "ãƒ¬ãƒ“", "Num": "æ°‘", "Deut": "ç”³",
            "Josh": "ãƒ¨ã‚·ãƒ¥", "Judg": "è£", "Ruth": "ãƒ«ãƒ„", "1Sam": "ã‚µãƒ ä¸€", "2Sam": "ã‚µãƒ äºŒ",
            "1Ki": "ç‹ä¸€", "2Ki": "ç‹äºŒ", "1Chr": "ä»£ä¸€", "2Chr": "ä»£äºŒ", "Ezra": "ã‚¨ã‚ºãƒ©",
            "Neh": "ãƒãƒ˜", "Esth": "ã‚¨ã‚¹", "Job": "ãƒ¨ãƒ–", "Ps": "è©©", "Prov": "ç®´",
            "Isa": "ã‚¤ã‚¶", "Jer": "ã‚¨ãƒ¬", "Lam": "å“€", "Ezek": "ã‚¨ã‚¼", "Dan": "ãƒ€ãƒ‹",
            "Amos": "ã‚¢ãƒ¢", "Jonah": "ãƒ¨ãƒŠ", "Mic": "ãƒŸã‚«", "Hab": "ãƒãƒ", "Mal": "ãƒãƒ©",
            "Matt": "ãƒã‚¿", "Mark": "ãƒãƒ«", "Luke": "ãƒ«ã‚«", "John": "ãƒ¨ãƒ", "Acts": "ä½¿å¾’",
            "Rom": "ãƒ­ãƒ", "1Cor": "ã‚³ãƒªä¸€", "2Cor": "ã‚³ãƒªäºŒ", "Gal": "ã‚¬ãƒ©", "Eph": "ã‚¨ãƒ•ã‚§",
            "Phil": "ãƒ•ã‚£ãƒª", "Col": "ã‚³ãƒ­", "1Thess": "ãƒ†ã‚µä¸€", "2Thess": "ãƒ†ã‚µäºŒ", "1Tim": "ãƒ†ãƒ¢ä¸€",
            "2Tim": "ãƒ†ãƒ¢äºŒ", "Titus": "ãƒ†ãƒˆ", "Philem": "ãƒ•ã‚£ãƒ¬", "Heb": "ãƒ˜ãƒ–", "Jas": "ãƒ¤ã‚³",
            "1Pet": "ãƒšãƒ†ä¸€", "2Pet": "ãƒšãƒ†äºŒ", "1John": "ãƒ¨ãƒä¸€", "2John": "ãƒ¨ãƒäºŒ", "3John": "ãƒ¨ãƒä¸‰",
            "Jude": "ãƒ¦ãƒ€", "Rev": "å•“"
        };

        const masterEvents = [
            { id: 1, ja: "ã‚¢ãƒ€ãƒ ã®å‰µé€ ", en: "Creation of Adam", year: -4026, ref: "Gen 2:7", hint_ja: "äººé¡ã®æ­´å²ã®å§‹ã¾ã‚Šã§ã™ã€‚", hint_en: "The beginning of human history." },
            { id: 2, ja: "ã‚¢ãƒ–ãƒ©ãƒãƒ ã¨ã®å¥‘ç´„", en: "Covenant with Abraham", year: -1943, ref: "Gen 12:4", hint_ja: "ã‚¢ãƒ–ãƒ©ãƒãƒ ãŒãƒ¦ãƒ¼ãƒ•ãƒ©ãƒ†ã‚¹å·ã‚’æ¸¡ã‚Šã¾ã—ãŸã€‚", hint_en: "Abraham crossed the Euphrates River." },
            { id: 3, ja: "ã‚¤ã‚µã‚¯ã‚’æ§ã’ã‚ˆã†ã¨ã™ã‚‹", en: "Isaac offered up", year: -1890, ref: "Gen 22:2", hint_ja: "ãƒ¢ãƒªãƒ¤ã®å±±ã§ã®ä¿¡ä»°ã®è©¦ã¿ã§ã™ã€‚", hint_en: "A test of faith on Mount Moriah." },
            { id: 4, ja: "å¤§æ´ªæ°´ãŒå§‹ã¾ã‚‹", en: "The Great Flood begins", year: -2370, ref: "Gen 7:11", hint_ja: "ãƒã‚¢ã®æ™‚ä»£ã€å…¨åœ°çƒãŒæ°´ã«è¦†ã‚ã‚Œã¾ã—ãŸã€‚", hint_en: "Global flood in the days of Noah." },
            { id: 5, ja: "ãƒãƒ™ãƒ«ã®å¡”", en: "Tower of Babel", year: -2269, ref: "Gen 11:9", hint_ja: "äººã€…ã®è¨€è‘‰ãŒæ··ä¹±ã•ã›ã‚‰ã‚ŒãŸå‡ºæ¥äº‹ã§ã™ã€‚", hint_en: "Languages were confused at Shinar." },
            { id: 6, ja: "ã‚¢ãƒ–ãƒ©ãƒãƒ ã®èª•ç”Ÿ", en: "Birth of Abraham", year: -2018, ref: "Gen 11:26", hint_ja: "ä¿¡ä»°ã®çˆ¶ã¨å‘¼ã°ã‚Œã‚‹äººã®èª•ç”Ÿã§ã™ã€‚", hint_en: "Birth of the father of faith." },
            { id: 7, ja: "ãƒ¤ã‚³ãƒ–ã®èª•ç”Ÿ", en: "Birth of Jacob", year: -1858, ref: "Gen 25:26", hint_ja: "ã‚¤ã‚µã‚¯ã®åŒå­ã®æ¯å­ã®ä¸€äººã§ã™ã€‚", hint_en: "One of the twin sons of Isaac." },
            { id: 8, ja: "ãƒ¨ã‚»ãƒ•ãŒã‚¨ã‚¸ãƒ—ãƒˆã¸å£²ã‚‰ã‚Œã‚‹", en: "Joseph sold into Egypt", year: -1750, ref: "Gen 37:28", hint_ja: "å…„å¼ŸãŸã¡ã«ã‚ˆã£ã¦å•†äººã«å£²ã‚‰ã‚Œã¾ã—ãŸã€‚", hint_en: "Sold to traders by his brothers." },
            { id: 9, ja: "ãƒ¤ã‚³ãƒ–ä¸€å®¶ãŒã‚¨ã‚¸ãƒ—ãƒˆã¸ç§»å‹•", en: "Jacob moves to Egypt", year: -1728, ref: "Gen 46:26", hint_ja: "é£¢é¥‰ã®ãŸã‚ã‚¨ã‚¸ãƒ—ãƒˆã¸ç§»ä½ã—ã¾ã—ãŸã€‚", hint_en: "Moved due to a severe famine." },
            { id: 10, ja: "ãƒ¢ãƒ¼ã‚»ã®èª•ç”Ÿ", en: "Birth of Moses", year: -1593, ref: "Exo 2:2", hint_ja: "ãƒŠã‚¤ãƒ«å·ã®ãƒ‘ãƒ”ãƒ«ã‚¹ã®ã‹ã”ã§ç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚", hint_en: "Found in a basket on the Nile." },
            { id: 14, ja: "ã‚¨ã‚¸ãƒ—ãƒˆè„±å‡º", en: "The Exodus", year: -1513, ref: "Exo 12:41", hint_ja: "ç´…æµ·ãŒåˆ†ã‹ã‚ŒãŸæœ‰åãªå‡ºæ¥äº‹ã§ã™ã€‚", hint_en: "The Red Sea parted for Israel." },
            { id: 15, ja: "å¾‹æ³•å¥‘ç´„ã®ç· çµ", en: "Law Covenant made", year: -1513, ref: "Exo 24:7", hint_ja: "ã‚·ãƒŠã‚¤å±±ã§åæˆ’ãªã©ãŒä¸ãˆã‚‰ã‚Œã¾ã—ãŸã€‚", hint_en: "The Ten Commandments given at Sinai." },
            { id: 16, ja: "å¹•å±‹ã®å®Œæˆ", en: "Tabernacle completed", year: -1512, ref: "Exo 40:17", hint_ja: "è’é‡ã«ãŠã‘ã‚‹å´‡æ‹ã®ä¸­å¿ƒåœ°ãŒå®Œæˆã—ã¾ã—ãŸã€‚", hint_en: "The portable center of worship finished." },
            { id: 20, ja: "ç´„æŸã®åœ°ã¸å…¥ã‚‹", en: "Entering Promised Land", year: -1473, ref: "Josh 3:15", hint_ja: "ãƒ¨ãƒ«ãƒ€ãƒ³å·ã‚’æ¸¡ã‚Šã‚«ãƒŠãƒ³ã®åœ°ã«å…¥ã‚Šã¾ã—ãŸã€‚", hint_en: "Crossed the Jordan into Canaan." },
            { id: 25, ja: "ã‚µã‚¦ãƒ«ãŒç‹ã«ãªã‚‹", en: "Saul becomes King", year: -1117, ref: "1Sam 10:24", hint_ja: "ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«ã®åˆä»£ã®ç‹ã§ã™ã€‚", hint_en: "The very first king of Israel." },
            { id: 27, ja: "ãƒ€ãƒ“ãƒ‡ãŒç‹ã«ãªã‚‹", en: "David becomes King", year: -1070, ref: "2Sam 5:3", hint_ja: "ã‚¨ãƒƒã‚µã‚¤ã®æœ«æ¯å­ãŒç‹ã¨ãªã‚Šã¾ã—ãŸã€‚", hint_en: "The youngest son of Jesse took the throne." },
            { id: 30, ja: "ã‚½ãƒ­ãƒ¢ãƒ³ãŒç‹ã«ãªã‚‹", en: "Solomon becomes King", year: -1037, ref: "1Ki 1:39", hint_ja: "çŸ¥æµã§æœ‰åãªç‹ãŒçµ±æ²»ã‚’å§‹ã‚ã¾ã—ãŸã€‚", hint_en: "The king famous for wisdom began his reign." },
            { id: 35, ja: "ç¥æ®¿ã®å®Œæˆ (ã‚½ãƒ­ãƒ¢ãƒ³)", en: "Solomon's Temple finished", year: -1027, ref: "1Ki 6:38", hint_ja: "ã‚¨ãƒ«ã‚µãƒ¬ãƒ ã«å£®éº—ãªç¥æ®¿ãŒå»ºã¡ã¾ã—ãŸã€‚", hint_en: "A magnificent temple built in Jerusalem." },
            { id: 40, ja: "ç‹å›½ãŒå—åŒ—ã«åˆ†è£‚", en: "Kingdom divided", year: -997, ref: "1Ki 12:19", hint_ja: "ãƒ¬ãƒãƒ–ã‚¢ãƒ ã®æ™‚ä»£ã€10éƒ¨æ—ãŒé›¢åã—ã¾ã—ãŸã€‚", hint_en: "Ten tribes revolted under Rehoboam." },
            { id: 50, ja: "ã‚µãƒãƒªã‚¢ã®é™¥è½", en: "Fall of Samaria", year: -740, ref: "2Ki 17:6", hint_ja: "åŒ—ã®ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«ç‹å›½ãŒã‚¢ãƒƒã‚·ãƒªã‚¢ã«æ»…ã¼ã•ã‚Œã¾ã—ãŸã€‚", hint_en: "Northern kingdom fell to Assyria." },
            { id: 51, ja: "ã‚¨ãƒ«ã‚µãƒ¬ãƒ æ»…äº¡ï¼ˆãƒãƒ“ãƒ­ãƒ³ï¼‰", en: "Jerusalem destroyed (Babylon)", year: -607, ref: "2Ki 25:8", hint_ja: "ãƒãƒ“ãƒ­ãƒ³è»ã«ã‚ˆã£ã¦éƒ½ãŒç°ã«ãªã‚Šã¾ã—ãŸã€‚", hint_en: "The city was burned by Babylon." },
            { id: 53, ja: "ãƒãƒ“ãƒ­ãƒ³é™¥è½", en: "Fall of Babylon", year: -539, ref: "Dan 5:30", hint_ja: "ã‚­ãƒ¥ãƒ­ã‚¹å¤§ç‹ã«ã‚ˆã£ã¦ä¸€å¤œã«ã—ã¦å é ˜ã•ã‚Œã¾ã—ãŸã€‚", hint_en: "Taken by Cyrus the Great in one night." },
            { id: 55, ja: "ã‚¨ãƒ«ã‚µãƒ¬ãƒ å¸°é‚„", en: "Return to Jerusalem", year: -537, ref: "Ezra 1:1", hint_ja: "æ•å›šã•ã‚Œã¦ã„ãŸæ°‘ãŒè§£æ”¾ã•ã‚Œã¦æˆ»ã‚Šã¾ã—ãŸã€‚", hint_en: "Exiles released to go back home." },
            { id: 60, ja: "åŸå£ã®å†å»º", en: "Rebuilding Walls", year: -455, ref: "Neh 6:15", hint_ja: "ãƒãƒ˜ãƒŸãƒ¤ãŒ52æ—¥é–“ã§å†å»ºã—ã¾ã—ãŸã€‚", hint_en: "Nehemiah rebuilt it in 52 days." },
            { id: 66, ja: "ã‚¤ã‚¨ã‚¹ã®èª•ç”Ÿ", en: "Birth of Jesus", year: -2, ref: "Luke 2:7", hint_ja: "ã€Œå‰2å¹´ã€ãŒè–æ›¸é€šã‚Šã®èª•ç”Ÿã®å¹´ã§ã™ã€‚", hint_en: "The year of birth according to Bible prophecy." },
            { id: 70, ja: "ã‚¤ã‚¨ã‚¹ã®å®£æ•™é–‹å§‹", en: "Jesus begins ministry", year: 29, ref: "Luke 3:23", hint_ja: "ãƒ¨ãƒ«ãƒ€ãƒ³å·ã§ãƒãƒ—ãƒ†ã‚¹ãƒã‚’å—ã‘ã‚‰ã‚Œã¾ã—ãŸã€‚", hint_en: "Baptized in the Jordan River." },
            { id: 77, ja: "ã‚¤ã‚¨ã‚¹ã®æ­»", en: "Death of Jesus", year: 33, ref: "John 19:30", hint_ja: "ãƒ‹ã‚µãƒ³ã®14æ—¥ã«ã€äººé¡ã®æ•‘ã„ã®ãŸã‚ã«äº¡ããªã‚Šã¾ã—ãŸã€‚", hint_en: "Died for mankind on Nisan 14." },
            { id: 80, ja: "è–éœŠãŒæ³¨ãŒã‚Œã‚‹ (ãƒšãƒ³ãƒ†ã‚³ã‚¹ãƒ†)", en: "Holy Spirit poured out", year: 33, ref: "Acts 2:4", hint_ja: "ã‚¯ãƒªã‚¹ãƒãƒ£ãƒ³ä¼šè¡†ãŒèª•ç”Ÿã—ã¾ã—ãŸã€‚", hint_en: "The Christian congregation was born." },
            { id: 85, ja: "ã‚³ãƒ«ãƒãƒªã‚ªã®è»¢å‘", en: "Conversion of Cornelius", year: 36, ref: "Acts 10:44", hint_ja: "ç•°é‚¦äººã«åˆã‚ã¦è–éœŠãŒæ³¨ãŒã‚Œã¾ã—ãŸã€‚", hint_en: "First Gentile to become a Christian." },
            { id: 106, ja: "ã‚¨ãƒ«ã‚µãƒ¬ãƒ æ»…äº¡ (ãƒ­ãƒ¼ãƒ)", en: "Jerusalem destroyed (Rome)", year: 70, ref: "Luke 19:43", hint_ja: "ãƒ†ã‚£ãƒˆã‚¥ã‚¹å°†è»ç‡ã„ã‚‹è»ã«æ»…ã¼ã•ã‚Œã¾ã—ãŸã€‚", hint_en: "Destroyed by General Titus." },
            { id: 110, ja: "è–æ›¸å…¨å·»ã®å®Œæˆ", en: "Bible completed", year: 98, ref: "1John 5:21", hint_ja: "ãƒ¨ãƒãƒãŒæœ€å¾Œã®æ›¸ã‚’æ›¸ãçµ‚ãˆãŸé ƒã§ã™ã€‚", hint_en: "Apostle John finished the last scrolls." }
        ];

        function formatRef(ref) {
            if (currentLang === 'en') return ref;
            let parts = ref.split(' ');
            let bookEn = parts[0];
            let verse = parts[1] || "";
            return verse
                ? (refMap[bookEn] || bookEn) + " " + verse
                : (refMap[bookEn] || bookEn);
        }

        /* ==========================================================
        è¨€èªã®è‡ªå‹•åˆ¤å®šï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ï¼‰
        - ä»¥å‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§é¸ã‚“ã è¨€èªãŒã‚ã‚Œã°ã€ãã‚Œã‚’å„ªå…ˆã™ã‚‹
        - ãã‚ŒãŒç„¡ã‘ã‚Œã°ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨€èªè¨­å®šã‚’è¦‹ã¦åˆ¤å®šã™ã‚‹
        - jaï¼ˆæ—¥æœ¬èªï¼‰ãªã‚‰ 'ja'
        - ãã‚Œä»¥å¤–ã¯å…¨éƒ¨ 'en'
        ========================================================== */
        function detectLanguage() {

            /* localStorageã«ä¿å­˜ã•ã‚ŒãŸè¨€èªãŒã‚ã‚Œã°æœ€å„ªå…ˆã§ä½¿ã†
               ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéå»ã«ã€ŒEN/JAã€ã‚’æŠ¼ã—ãŸçµæœã‚’è¦šãˆã¦ãŠããŸã‚ï¼‰ */
            const savedLang = localStorage.getItem('lang');
            if (savedLang) {
                currentLang = savedLang;
                return;
            }

            /* ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨€èªè¨­å®šã‚’å–å¾—ï¼ˆä¾‹: "ja-JP", "en-US" ãªã©ï¼‰ */
            const browserLang = navigator.language || navigator.userLanguage || '';

            /* "ja" ã§å§‹ã¾ã‚‹ãªã‚‰æ—¥æœ¬èªæ‰±ã„ã€‚ãã†ã§ãªã‘ã‚Œã°è‹±èª */
            if (browserLang.toLowerCase().startsWith('ja')) {
                currentLang = 'ja';
            } else {
                currentLang = 'en';
            }
        }

        function toggleLang() {
            /* JA â‡„ EN ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
            currentLang = currentLang === 'ja' ? 'en' : 'ja';
            document.documentElement.lang = currentLang;
            /* æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã‚‚åŒã˜è¨€èªã§é–‹ããŸã‚ã«ä¿å­˜ã™ã‚‹ */
            localStorage.setItem('lang', currentLang);
            /* ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆä»ŠãŒæ—¥æœ¬èªãªã‚‰ "JA"ã€è‹±èªãªã‚‰ "EN"ï¼‰ */
            document.getElementById('lang-btn').innerText =
                currentLang === 'ja' ? 'JA' : 'EN';
            /* data-ja / data-en ã‚’æŒã¤è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã¦å·®ã—æ›¿ãˆã‚‹ */
            document.querySelectorAll('[data-ja]').forEach(el => {
                el.innerText = el.getAttribute('data-' + currentLang);
            });

            /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚‚ä»Šã®è¨€èªã§æ›´æ–°ã™ã‚‹ */
            updateCardTexts();
            /* å¹´ä»£ã®ã‚»ãƒ¬ã‚¯ãƒˆãªã©ã€è¨€èªä¾å­˜ã®è¡¨ç¤ºã‚’å†æ§‹ç¯‰ã™ã‚‹ */
            initPickers();
            /* çµæœç”»é¢ï¼ˆæ­£è§£/æ®‹å¿µ/ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰ã‚’ç¾åœ¨è¨€èªã§å†æç”» */
            updateResultTexts();
            /* ãƒ’ãƒ³ãƒˆè¡¨ç¤ºä¸­ãªã‚‰ã€ãƒ’ãƒ³ãƒˆæ–‡ç« ã‚’ç¾åœ¨è¨€èªã§å†æç”» */
            updateHintTexts();
        }

        function updateCardTexts() {
            document.querySelectorAll('.event-card').forEach(card => {
                const data = masterEvents.find(e => e.id == card.dataset.id);
                if (data) card.querySelector('.event-name').innerText = data[currentLang];
            });
        }

        function initPickers() {
            const s = document.getElementById('select-start'), e = document.getElementById('select-end');
            const sOld = s.value, eOld = e.value;
            s.innerHTML = ''; e.innerHTML = '';
            const years = [...new Set(masterEvents.map(ev => ev.year))].sort((a, b) => a - b);
            years.forEach(y => {
                let label = currentLang === 'ja' ? (y < 0 ? `å‰ ${Math.abs(y)}å¹´` : `è¥¿æš¦ ${y}å¹´`) : (y < 0 ? `BCE ${Math.abs(y)}` : `CE ${y}`);
                s.add(new Option(label, y)); e.add(new Option(label, y));
            });
            if (sOld) s.value = sOld; if (eOld) e.value = eOld;
        }

        function quickSet(sVal, eVal, btn) {
            document.getElementById('select-start').value = sVal;
            document.getElementById('select-end').value = eVal;
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('error-msg').innerText = "";
        }

        function startGame() {
            const s = parseInt(document.getElementById('select-start').value);
            const e = parseInt(document.getElementById('select-end').value);
            const count = parseInt(document.getElementById('count-select').value);
            let filtered = masterEvents.filter(ev => ev.year >= s && ev.year <= e);
            if (filtered.length < count) {
                const msg = currentLang === 'ja' ? `ã‚¤ãƒ™ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨${filtered.length}å€‹ï¼‰` : `Not enough events (Only ${filtered.length} available)`;
                document.getElementById('error-msg').innerText = msg;
                return;
            }
            document.getElementById('error-msg').innerText = "";
            currentTask = filtered.sort(() => 0.5 - Math.random()).slice(0, count);

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯è¨­å®š
            const isTimeAttack = document.getElementById('time-attack-select').value === 'on';
            clearInterval(timerInterval);

            if (isTimeAttack) {
                document.getElementById('timer-display').classList.remove('hidden');
                timeLeft = count * 15;
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert(currentLang === 'ja' ? "æ™‚é–“åˆ‡ã‚Œï¼" : "Time's Up!");
                        checkOrder();
                    }
                }, 1000);
            } else {
                document.getElementById('timer-display').classList.add('hidden');
            }

            renderGame(true);
            switchScreen('screen-game');
        }

        function updateTimerDisplay() {
            document.getElementById('time-left').innerText = timeLeft;
        }

        function renderGame(shuffle) {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            let displayList = [...currentTask];
            if (shuffle) displayList.sort(() => 0.5 - Math.random());
            displayList.forEach(item => {
                const el = document.createElement('div');
                el.className = 'event-card';
                el.dataset.id = item.id;
                el.innerHTML = `<span class="material-icons drag-handle" aria-label="drag" style="color:#ccc">drag_indicator</span><div class="event-name" style="flex:1">${item[currentLang]}</div>`;
                // â˜…ã‚¹ãƒãƒ›ï¼šã‚«ãƒ¼ãƒ‰å…¨ä½“ã§ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
                el.ontouchstart = handleTouchStart;
                el.ontouchmove = handleTouchMove;
                el.ontouchend = handleTouchEnd;
                el.ontouchcancel = handleTouchEnd;

                list.appendChild(el);
            });
            list.ondragover = e => {
                e.preventDefault();
                const draggingItem = document.querySelector('.dragging');
                const afterElement = getDragAfterElement(list, e.clientY);
                if (afterElement == null) list.appendChild(draggingItem);
                else list.insertBefore(draggingItem, afterElement);
            };
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.event-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        let activeItem = null;
        let placeholder = null;

        /* é•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰ */
        let pressTimer = null;
        let isDragging = false;

        let preMoveListener = null;

        function attachPreMoveCancel() {
            if (preMoveListener) return;

            preMoveListener = (ev) => {
                if (!pressTimer || isDragging) return;

                const t = ev.touches[0];
                const dx = t.clientX - startX;
                const dy = t.clientY - startY;
                const dist = Math.hypot(dx, dy);

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã¤ã‚‚ã‚Š â†’ é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                if (dist > CANCEL_MOVE_THRESHOLD) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                    detachPreMoveCancel();
                }
            };

            // â˜…ã“ã“ã¯ passive:true ã§OKï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‚ªé­”ã—ãªã„ï¼‰
            document.addEventListener('touchmove', preMoveListener, { passive: true });
        }

        function detachPreMoveCancel() {
            if (!preMoveListener) return;
            document.removeEventListener('touchmove', preMoveListener);
            preMoveListener = null;
        }

        /* ã‚¿ãƒƒãƒé–‹å§‹ä½ç½®ï¼ˆé•·æŠ¼ã—æˆç«‹å‰ã®ç§»å‹•åˆ¤å®šç”¨ï¼‰ */
        let startX = 0;
        let startY = 0;

        /* å¥½ã¿ã§èª¿æ•´OK */
        const LONG_PRESS_MS = 200;          // é•·æŠ¼ã—æ™‚é–“
        const CANCEL_MOVE_THRESHOLD = 10;   // ã“ã‚Œä»¥ä¸Šå‹•ã„ãŸã‚‰é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆpxï¼‰

        /* æŒ‡ã®ä½ç½®ã¨ã‚«ãƒ¼ãƒ‰å·¦ä¸Šã®å·®åˆ†ï¼ˆè¿½å¾“ç”¨ï¼‰ */
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        /* è¿½å¾“ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ãŸã‚ã® rAF åˆ¶å¾¡ */
        let rafId = null;
        let pendingX = 0;
        let pendingY = 0;

        function handleTouchStart(e) {
            // ã“ã“ã§ã¯ã¾ã ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰
            isDragging = false;

            // ã‚«ãƒ¼ãƒ‰ã‚’æ´ã‚“ã æ‰±ã„ã«ã™ã‚‹
            activeItem = this;
            if (!activeItem) return;

            // åˆæœŸã‚¿ãƒƒãƒä½ç½®ï¼ˆå‹•ã„ãŸã‚‰é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãŸã‚ï¼‰
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            attachPreMoveCancel();

            document.addEventListener(
                'touchend',
                () => {
                    if (!isDragging && pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                },
                { passive: true, once: true }
            );

            document.addEventListener(
                'touchcancel',
                () => {
                    if (!isDragging && pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                },
                { passive: true, once: true }
            );

            // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }

            // é•·æŠ¼ã—æˆç«‹ã—ãŸã‚‰ã€Œã“ã“ã§åˆã‚ã¦ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã€
            pressTimer = setTimeout(() => {
                // â˜…ã“ã“ã«æ¥ãŸæ™‚ç‚¹ã§ã€æŒ‡ãŒé›¢ã‚Œã¦ã„ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ã‚‹ã¯ãšã ãŒå¿µã®ãŸã‚
                if (isDragging) return;
                if (!activeItem) return;

                // ã“ã“ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                isDragging = true;
                // â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œçŸ¥ã¯ã‚‚ã†ä¸è¦
                detachPreMoveCancel();
                activeItem.classList.add('dragging');

                // é•·æŠ¼ã—å¾…ã¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç›£è¦–ã‚’å¤–ã™ï¼ˆä¿é™ºï¼‰
                document.removeEventListener('touchend', cancelLongPress);
                document.removeEventListener('touchcancel', cancelLongPress);

                /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æŒ‡ã®å‹•ãã‚’å–ã‚Šã“ã¼ã•ãªã„ãŸã‚ */
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd, { passive: false });
                document.addEventListener('touchcancel', handleTouchEnd, { passive: false });

                /* è¿½å¾“ç”¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—ï¼ˆã‚«ãƒ¼ãƒ‰å·¦ä¸Šã¨ã®å·®åˆ†ï¼‰ */
                const rect = activeItem.getBoundingClientRect();
                dragOffsetX = startX - rect.left;
                dragOffsetY = startY - rect.top;

                /* placeholder ã‚’ç”¨æ„ï¼ˆç„¡ã‘ã‚Œã°ä½œã‚‹ï¼‰ */
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.className = 'sortable-placeholder';
                }
                placeholder.style.height = rect.height + "px";

                // å…ƒã®å ´æ‰€ã‚’ placeholder ã«ç½®ãæ›ãˆã‚‹ï¼ˆâ†ã“ã‚Œã¯å¿…è¦ï¼‰
                activeItem.replaceWith(placeholder);

                // â˜…ã‚«ãƒ¼ãƒ‰ã¯ãƒªã‚¹ãƒˆã«æˆ»ã•ãšã€body ã«é€€é¿ã•ã›ã‚‹
                document.body.appendChild(activeItem);


                /* è¦‹ãŸç›®ï¼šãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‚¹ã‚¿ã‚¤ãƒ« */
                activeItem.style.width = rect.width + "px";
                activeItem.style.height = rect.height + "px";
                activeItem.style.position = "fixed";
                activeItem.style.zIndex = "9999";
                activeItem.style.pointerEvents = "none";
                activeItem.style.opacity = "0.9";
                activeItem.style.margin = "0";              // â˜…ã‚ºãƒ¬é˜²æ­¢
                activeItem.style.boxSizing = "border-box";  // â˜…å¿µã®ãŸã‚
                activeItem.style.left = rect.left + "px";   // â˜…åˆæœŸä½ç½®å›ºå®š
                activeItem.style.top = rect.top + "px";

                /* æœ€åˆã®ä½ç½®æ›´æ–°ï¼ˆæŒ‡ã«è¿½å¾“ï¼‰ */
                moveDraggedItem(startX, startY);

                // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã„æ¨ã¦ã«ã™ã‚‹
                pressTimer = null;
            }, LONG_PRESS_MS);
        }

        function moveDraggedItem(clientX, clientY) {
            // æŒ‡ã®ä½ç½®ï¼ˆpendingï¼‰ã‚’æ›´æ–°
            pendingX = clientX;
            pendingY = clientY;

            // ã™ã§ã« rAF ãŒå›ã£ã¦ã‚‹ãªã‚‰äºˆç´„ã ã‘æ›´æ–°ã—ã¦çµ‚ã‚ã‚Š
            if (rafId) return;

            rafId = requestAnimationFrame(() => {
                rafId = null;
                if (!activeItem) return;

                const left = pendingX - dragOffsetX;
                const top = pendingY - dragOffsetY;

                activeItem.style.left = left + "px";
                activeItem.style.top = top + "px";
            });
        }

        function handleTouchMove(e) {
            if (!activeItem) return;

            const touch = e.touches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            if (!isDragging) return; // â† é•·æŠ¼ã—æˆç«‹å‰ã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä»»ã›ã‚‹ï¼‰

            // ã“ã“ã‹ã‚‰ä¸‹ã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸­
            e.preventDefault();

            // è¿½å¾“ï¼ˆrAFã§æ»‘ã‚‰ã‹ã«å‹•ã‹ã™ã‚ãªãŸã®ä»•çµ„ã¿ã‚’ä½¿ã†ï¼‰
            moveDraggedItem(x, y);

            // æŒ‡ã®ä¸‹ã®è¦ç´ ã‹ã‚‰ã€ŒæŒ¿å…¥å…ˆã€ã‚’æ±ºã‚ã¦ placeholder ã‚’ç§»å‹•
            const target = document.elementFromPoint(x, y);
            const card = target ? target.closest('.event-card') : null;

            if (!card || card === activeItem || card === placeholder) return;

            const rect = card.getBoundingClientRect();
            if (y < rect.top + rect.height / 2) {
                card.before(placeholder);
            } else {
                card.after(placeholder);
            }
        }

        function handleTouchEnd() {
            // é•·æŠ¼ã—å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹ï¼ˆã“ã“1å›ã ã‘ã§OKï¼‰
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }

            // ãã‚‚ãã‚‚ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ã¦ãªã‹ã£ãŸï¼ˆãŸã ã®ã‚¿ãƒƒãƒ—/ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ãªã‚‰çµ‚äº†
            if (!isDragging) {
                detachPreMoveCancel();
                activeItem = null;
                return;
            }

            // ã“ã“ã‹ã‚‰ã€Œãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã€
            isDragging = false;

            if (!activeItem) return;

            /* requestAnimationFrame ã‚’æ­¢ã‚ã‚‹ï¼ˆæ®‹åƒãƒ»ã‚«ã‚¯ã¤ãé˜²æ­¢ï¼‰ */
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }

            const list = document.getElementById('event-list');

            if (placeholder && list && list.contains(placeholder)) {
                placeholder.replaceWith(activeItem);
                placeholder = null;
            } else if (list && activeItem) {
                // ä¸‡ä¸€ placeholder ãŒç„¡ã„å ´åˆã¯æœ«å°¾ã«æˆ»ã™
                list.appendChild(activeItem);
            }


            /* è¦‹ãŸç›®ã‚’å®Œå…¨ã«å…ƒã«æˆ»ã™ */
            activeItem.classList.remove('dragging');

            activeItem.style.position = '';
            activeItem.style.left = '';
            activeItem.style.top = '';
            activeItem.style.right = '';
            activeItem.style.bottom = '';

            activeItem.style.width = '';
            activeItem.style.height = '';           // â˜…ã“ã‚Œé‡è¦ï¼ˆStartã§å›ºå®šã—ã¦ã‚‹ãŸã‚ï¼‰
            activeItem.style.zIndex = '';
            activeItem.style.pointerEvents = '';
            activeItem.style.margin = '';
            activeItem.style.transform = '';
            activeItem.style.opacity = '1';

            activeItem = null;

            // document ç›£è¦–ã‚’è§£é™¤
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
            document.removeEventListener('touchcancel', handleTouchEnd);
        }

        function checkOrder() {
            clearInterval(timerInterval);

            const userIds = [...document.querySelectorAll('.event-card')]
                .map(el => parseInt(el.dataset.id));

            const correctIds = [...currentTask]
                .sort((a, b) => a.year - b.year)
                .map(e => e.id);

            const isWin = JSON.stringify(userIds) === JSON.stringify(correctIds);

            if (isWin && window.confetti) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { x: 0.5, y: 0.5 }
                });
            }

            showResultScreen(isWin);
        }

        /* ==========================================================
        çµæœç”»é¢ã®æ–‡è¨€ã‚’ currentLang ã«åˆã‚ã›ã¦æ›´æ–°ã™ã‚‹
        - toggleLang() ã‹ã‚‰ã‚‚å‘¼ã°ã‚Œã‚‹
        - å‹æ•—ï¼ˆlastIsWinï¼‰ã‚’å…ƒã«è¡¨ç¤ºã‚’æ±ºã‚ã‚‹
        ========================================================== */
        function updateResultTexts() {
            if (lastIsWin === null) return;

            const difficulty =
                parseInt(document.getElementById('count-select').value);

            if (!lastIsWin && difficulty === 30) {
                document.getElementById('result-title').innerText =
                    currentLang === 'ja' ? "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼" : "Game Over";
            } else {
                document.getElementById('result-title').innerText = lastIsWin
                    ? (currentLang === 'ja' ? "æ­£è§£ï¼" : "Correct!")
                    : (currentLang === 'ja' ? "æ®‹å¿µ" : "Oops");
            }
        }

        /* ==========================================================
        ãƒ’ãƒ³ãƒˆè¡¨ç¤ºã®æ–‡è¨€ã‚’ currentLang ã«åˆã‚ã›ã¦æ›´æ–°ã™ã‚‹
        - toggleLang() ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
        - ç›´å‰ã«è¡¨ç¤ºã—ãŸãƒ’ãƒ³ãƒˆã®å†…å®¹ï¼ˆlastHintIds / lastHintWasEmptyï¼‰ã‚’å…ƒã«å†æ§‹ç¯‰ã™ã‚‹
        - ãƒ’ãƒ³ãƒˆãŒè¡¨ç¤ºä¸­ã§ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        ========================================================== */
        function updateHintTexts() {

            /* ãƒ’ãƒ³ãƒˆé ˜åŸŸãŒå­˜åœ¨ã—ãªã„ãƒšãƒ¼ã‚¸ãªã‚‰ä½•ã‚‚ã—ãªã„ */
            const hintArea = document.getElementById('hint-area');
            if (!hintArea) return;

            /* ãƒ’ãƒ³ãƒˆãŒãã‚‚ãã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ï¼ˆhiddenï¼‰ãªã‚‰ä½•ã‚‚ã—ãªã„ */
            if (hintArea.classList.contains('hidden')) return;

            /* showHint() ãŒã¾ã ä¸€åº¦ã‚‚å‘¼ã°ã‚Œã¦ã„ãªã„ãªã‚‰ä½•ã‚‚ã—ãªã„ */
            if (lastHintIds === null && lastHintWasEmpty === null) return;

            /* ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè¦‹å‡ºã—ï¼‰ */
            const title = currentLang === 'ja'
                ? "ğŸ’¡ èª¿æŸ»ã®åŠ©ã‘:"
                : "ğŸ’¡ Clues for misplaced items:";

            let html = `<strong>${title}</strong><br><br>`;

            /* ã€Œä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã€ã‚±ãƒ¼ã‚¹ */
            if (lastHintWasEmpty) {
                html += currentLang === 'ja'
                    ? "ä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚"
                    : "The order seems correct.";

                hintArea.innerHTML = html;
                return;
            }

            /* é€šå¸¸ã‚±ãƒ¼ã‚¹ï¼šlastHintIds ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¼•ã„ã¦å†æ§‹ç¯‰ */
            const hints = (lastHintIds || [])
                .map(id => masterEvents.find(e => e.id === id))
                .filter(Boolean);

            /* å¿µã®ãŸã‚ï¼šå¾©å…ƒã§ããªã‹ã£ãŸã‚‰ç©ºæ‰±ã„ã«ã™ã‚‹ */
            if (hints.length === 0) {
                html += currentLang === 'ja'
                    ? "ä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚"
                    : "The order seems correct.";

                hintArea.innerHTML = html;
                return;
            }

            hints.forEach(s => {
                const hintDesc = s['hint_' + currentLang] || "";
                html += `<div class="hint-item">
                    ãƒ»${s[currentLang]} (${formatRef(s.ref)})
                    <span class="hint-desc">${hintDesc}</span>
                 </div>`;
            });

            hintArea.innerHTML = html;
        }

        function showResultScreen(isWin) {

            /* ç›´å‰ã®å‹æ•—ã‚’ä¿å­˜ï¼ˆè¨€èªåˆ‡æ›¿æ™‚ã«å†æç”»ã™ã‚‹ãŸã‚ï¼‰ */
            lastIsWin = isWin;

            switchScreen('screen-result');
            const difficulty = parseInt(
                document.getElementById('count-select').value
            );

            /* ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã¯ã“ã“ã§æ±ºå®šã—ã¦OK */
            document.getElementById('result-icon').innerText =
                isWin ? "celebration" : "book";

            /* ãƒœã‚¿ãƒ³è¡¨ç¤ºã®åˆ¶å¾¡ */
            if (!isWin && difficulty === 30) {
                document.getElementById('fail-options').className = "hidden";
                document.getElementById('success-options').className = "";
            } else {
                document.getElementById('fail-options').className =
                    isWin ? "hidden" : "";
                document.getElementById('success-options').className =
                    isWin ? "" : "hidden";
            }

            /* â˜… çµæœã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…ãšã“ã“ã§ä¸€æ‹¬æ›´æ–° */
            updateResultTexts();
        }

        function showHint() {
            const userCards = [...document.querySelectorAll('.event-card')];
            const userIds = userCards.map(el => parseInt(el.dataset.id));
            const correctOrder = [...currentTask].sort((a, b) => a.year - b.year);
            const correctIds = correctOrder.map(e => e.id);

            let wrongEvents = [];
            userIds.forEach((id, index) => {
                if (id !== correctIds[index]) {
                    const event = masterEvents.find(e => e.id === id);
                    wrongEvents.push(event);
                }
            });

            const difficulty = parseInt(document.getElementById('count-select').value);
            const pickupCount = (difficulty === 12) ? 1 : 2;
            const hintsToShow = wrongEvents.sort(() => 0.5 - Math.random()).slice(0, pickupCount);
            /* ==========================================================
                ç›´å‰ã®ãƒ’ãƒ³ãƒˆå†…å®¹ã‚’ä¿å­˜ï¼ˆè¨€èªåˆ‡æ›¿æ™‚ã®å†æç”»ç”¨ï¼‰
                - lastHintIds: ä»Šå›ãƒ’ãƒ³ãƒˆã«å‡ºã—ãŸã‚¤ãƒ™ãƒ³ãƒˆIDã®é…åˆ—
                - lastHintWasEmpty: ãƒ’ãƒ³ãƒˆãŒç©ºï¼ˆä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ï¼‰ã ã£ãŸã‹
            ========================================================== */
            lastHintIds = hintsToShow.map(e => e.id);
            lastHintWasEmpty = (hintsToShow.length === 0);

            const title = currentLang === 'ja' ? "ğŸ’¡ èª¿æŸ»ã®åŠ©ã‘:" : "ğŸ’¡ Clues for misplaced items:";
            let html = `<strong>${title}</strong><br><br>`;

            if (hintsToShow.length === 0) {
                html += currentLang === 'ja' ? "ä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚" : "The order seems correct.";
            } else {
                hintsToShow.forEach(s => {
                    const hintDesc = s['hint_' + currentLang] || "";
                    html += `<div class="hint-item">
                            ãƒ»${s[currentLang]} (${formatRef(s.ref)})
                            <span class="hint-desc">${hintDesc}</span>
                         </div>`;
                });
            }

            document.getElementById('hint-area').innerHTML = html;
            document.getElementById('hint-area').classList.remove('hidden');
            switchScreen('screen-game');

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ONã®å ´åˆã®ã¿ã‚¿ã‚¤ãƒãƒ¼å†å§‹å‹•
            const isTimeAttack = document.getElementById('time-attack-select').value === 'on';
            if (isTimeAttack) {
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert(currentLang === 'ja' ? "æ™‚é–“åˆ‡ã‚Œï¼" : "Time's Up!");
                        checkOrder();
                    }
                }, 1000);
            }
        }

        function retryThisTask() {
            document.getElementById('hint-area').classList.add('hidden');
            renderGame(false);
            switchScreen('screen-game');

            const isTimeAttack = document.getElementById('time-attack-select').value === 'on';
            if (isTimeAttack) {
                const count = parseInt(document.getElementById('count-select').value);
                timeLeft = count * 15;
                updateTimerDisplay();
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert(currentLang === 'ja' ? "æ™‚é–“åˆ‡ã‚Œï¼" : "Time's Up!");
                        checkOrder();
                    }
                }, 1000);
            }
        }

        function switchScreen(id) {
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }
        /* ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸç¬é–“ã«ã‚„ã‚‹ã“ã¨ï¼ˆåˆæœŸåŒ–ï¼‰ */
        window.onload = () => {

            /* 1) ãƒ–ãƒ©ã‚¦ã‚¶è¨€èª or ä¿å­˜æ¸ˆã¿è¨€èªã‚’è¦‹ã¦ currentLang ã‚’æ±ºã‚ã‚‹ */
            detectLanguage();
            document.documentElement.lang = currentLang;

            /* 2) è¨€èªãƒœã‚¿ãƒ³ï¼ˆJA/ENï¼‰ã®è¡¨ç¤ºã‚’ currentLang ã«åˆã‚ã›ã‚‹ */
            const langBtn = document.getElementById('lang-btn');
            if (langBtn) {
                langBtn.innerText = currentLang === 'ja' ? 'JA' : 'EN';
            }

            /* 3) data-ja / data-en ã®æ–‡è¨€ã‚’ currentLang ã®è¨€èªã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                  â€» ã“ã‚Œã‚’ã‚„ã‚‰ãªã„ã¨ã€HTMLã«ç›´æ›¸ãã•ã‚ŒãŸåˆæœŸè¡¨ç¤ºã®ã¾ã¾ã«ãªã‚‹ */
            document.querySelectorAll('[data-ja]').forEach(el => {
                el.innerText = el.getAttribute('data-' + currentLang);
            });

            /* 4) å¹´ä»£ã‚»ãƒ¬ã‚¯ãƒˆç­‰ã‚’ currentLang ã§æç”»ã™ã‚‹ï¼ˆBCE/CEè¡¨ç¤ºã‚‚å«ã‚€ï¼‰ */
            initPickers();

            /* 5) åˆæœŸã®é–‹å§‹/çµ‚äº†ã‚’ã‚»ãƒƒãƒˆï¼ˆselect ãŒå­˜åœ¨ã™ã‚‹ãƒšãƒ¼ã‚¸ã ã‘ï¼‰ */
            const startSel = document.getElementById('select-start');
            const endSel = document.getElementById('select-end');
            if (startSel && endSel) {
                startSel.value = -4026;
                endSel.value = 98;
            }
        };


    </script>
</body>

</html>
